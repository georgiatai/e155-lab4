/*********************************************************************
*                    SEGGER Microcontroller GmbH                     *
*                        The Embedded Experts                        *
**********************************************************************

-------------------------- END-OF-HEADER -----------------------------

File    : main.c
Purpose : Generic application start

*/

/////////////////////////
// main.c
// Author: Georgia Tai, ytai@g.hmc.edu
// Date: Sep 29, 2025
// 
// Main function to play two songs on the MCU using PWM generation on the timers.
/////////////////////////

#include "STM32L432KC_RCC.h"
#include "STM32L432KC_TIM.h"
#include "STM32L432KC_GPIO.h"
#include "STM32L432KC_FLASH.h"
#include <stdio.h>

// Pitch in Hz, duration in ms
// Score for Fur Elise by Beethoven
const int fur_elise[][2] = {
    {659,	125},
    {623,	125},
    {659,	125},
    {623,	125},
    {659,	125},
    {494,	125},
    {587,	125},
    {523,	125},
    {440,	250},
    {  0,	125},
    {262,	125},
    {330,	125},
    {440,	125},
    {494,	250},
    {  0,	125},
    {330,	125},
    {416,	125},
    {494,	125},
    {523,	250},
    {  0,	125},
    {330,	125},
    {659,	125},
    {623,	125},
    {659,	125},
    {623,	125},
    {659,	125},
    {494,	125},
    {587,	125},
    {523,	125},
    {440,	250},
    {  0,	125},
    {262,	125},
    {330,	125},
    {440,	125},
    {494,	250},
    {  0,	125},
    {330,	125},
    {523,	125},
    {494,	125},
    {440,	250},
    {  0,	125},
    {494,	125},
    {523,	125},
    {587,	125},
    {659,	375},
    {392,	125},
    {699,	125},
    {659,	125},
    {587,	375},
    {349,	125},
    {659,	125},
    {587,	125},
    {523,	375},
    {330,	125},
    {587,	125},
    {523,	125},
    {494,	250},
    {  0,	125},
    {330,	125},
    {659,	125},
    {  0,	250},
    {659,	125},
    {1319,	125},
    {  0,	250},
    {623,	125},
    {659,	125},
    {  0,	250},
    {623,	125},
    {659,	125},
    {623,	125},
    {659,	125},
    {623,	125},
    {659,	125},
    {494,	125},
    {587,	125},
    {523,	125},
    {440,	250},
    {  0,	125},
    {262,	125},
    {330,	125},
    {440,	125},
    {494,	250},
    {  0,	125},
    {330,	125},
    {416,	125},
    {494,	125},
    {523,	250},
    {  0,	125},
    {330,	125},
    {659,	125},
    {623,	125},
    {659,	125},
    {623,	125},
    {659,	125},
    {494,	125},
    {587,	125},
    {523,	125},
    {440,	250},
    {  0,	125},
    {262,	125},
    {330,	125},
    {440,	125},
    {494,	250},
    {  0,	125},
    {330,	125},
    {523,	125},
    {494,	125},
    {440,	500},
    {  0,	250} // rest for the next song
};

// Score for Cheat Code by NCT WISH
const int cheat_code[][2] = {
    {370,  250}, // G♭4
    {311,  250}, // E♭4
    {311,  500}, // E♭4
    {370,  250}, // G♭4
    {466,  250}, // B♭4
    {415,  250}, // A♭4
    {370,  250}, // G♭4

    {349,  500}, // F4
    {277,  500}, // D♭4
    {349,  250}, // F4
    {415,  250}, // A♭4
    {370,  250}, // G♭4
    {349,  250}, // F4

    {311,  250}, // E♭4
    {370,  125}, // G♭4
    {311,  500}, // E♭4
    {311,  125}, // E♭4
    {349,  250}, // F4
    {415,  125}, // A♭4
    {349,  625}, // F4

    {466,  500}, // B♭4
    {466,  500}, // B♭4
    {466,  125}, // B♭4
    {466,  125}, // B♭4
    {466,  750}, // B♭4

    {370,  500}, // G♭4
    {311,  250}, // E♭4
    {311,  125}, // E♭4
    {370,  375}, // G♭4
    {466,  250}, // B♭4
    {415,  250}, // A♭4
    {370,  250}, // G♭4

    {415,  500}, // A♭4
    {554,  375}, // D♭5
    {466,  625}, // B♭4
    {415,  250}, // A♭4
    {466,  250}, // B♭4

    {493,  125}, // C♭5
    {466,  250}, // B♭4
    {466,  125}, // B♭4
    {415,  375}, // A♭4
    {415,  125}, // A♭4
    {370,  125}, // G♭4
    {493,  125}, // C♭5
    {466,  250}, // B♭4
    {466,  125}, // B♭4
    {415,  250}, // A♭4
    {554, 1625}, // D♭5

    {311,  250}, // E♭4
    {349,  250}, // F4

    {370,  500}, // G♭4
    {311,  500}, // E♭4
    {370,  250}, // G♭4
    {466,  250}, // B♭4
    {415,  250}, // A♭4
    {370,  250}, // G♭4

    {349,  500}, // F4
    {277,  500}, // D♭4
    {349,  250}, // F4
    {415,  250}, // A♭4
    {370,  250}, // G♭4
    {349,  250}, // F4

    {311,  250}, // E♭4
    {370,  125}, // G♭4
    {311,  500}, // E♭4
    {311,  125}, // E♭4
    {349,  250}, // F4
    {415,  125}, // A♭4
    {349,  625}, // F4

    {466,  500}, // B♭4
    {466,  500}, // B♭4
    {466,  125}, // B♭4
    {466,  125}, // B♭4
    {466,  750}, // B♭4

    {370,  500}, // G♭4
    {311,  250}, // E♭4
    {311,  125}, // E♭4
    {370,  375}, // G♭4
    {466,  250}, // B♭4
    {415,  250}, // A♭4
    {370,  250}, // G♭4

    {415,  500}, // A♭4
    {554,  375}, // D♭5
    {466,  625}, // B♭4
    {415,  250}, // A♭4
    {466,  250}, // B♭4

    {493,  125}, // C♭5
    {466,  250}, // B♭4
    {466,  250}, // B♭4
    {415,  125}, // A♭4
    {370,  500}, // G♭4
    {493,  375}, // D♭4
    {415, 1375}, // A♭4

    {466,  500}, // B♭4
    {493,  375}, // C♭5
    {415,  125}, // A♭4
    {  0, 1000}, // Rest

    {415,  500}, // A♭4
    {466,  375}, // B♭4
    {370,  125}, // G♭4
    {  0, 1000}, // Rest

    {  0,    0}  // End of song
};

int main(void) {
    configureFlash();
    configureClock();
	
    // Setting up clocks
    RCC->AHB2ENR |= (1 << 0);  // GPIOA
    RCC->APB2ENR |= (1 << 16); // TIM15
    RCC->APB2ENR |= (1 << 17); // TIM16

    // Setting up GPIOA
    pinMode(6, 2); // PA6 as alternate function (TIM16_CH1)

    GPIO->AFRL &= ~(0b1111 << 4*6); // Clear AFRL5
    GPIO->AFRL |=  (0b1110 << 4*6); // Set AFRL5 to AF2 (TIM15_CH1)
    
    // Initialize timers
    int psc_val_cnt = 4999; // freq_CLK / (psc_val + 1) = (80 MHz / (4999 + 1)) = 16  kHz
    int psc_val_pwm = 799;  // freq_CLK / (psc_val + 1) = (80 MHz / (799 + 1))  = 100 kHz

    initTIM(TIM15, psc_val_cnt);
    initPWM(TIM16, psc_val_pwm);

    // for loop for Fur Elise
    for (int i = 0; i < (sizeof(fur_elise)/sizeof(fur_elise[0])) ; i++) {
        int note_freq = fur_elise[i][0];
        int note_dur  = fur_elise[i][1];

        PWM_setDutyCycle(TIM16, note_freq, 50, psc_val_pwm); // 50% duty cycle
        delay_millis(TIM15, note_dur, psc_val_cnt);
    }

    // for loop for Cheat Code
    for (int i = 0; i < (sizeof(cheat_code)/sizeof(cheat_code[0])) ; i++) {
        int note_freq = cheat_code[i][0];
        int note_dur  = cheat_code[i][1];

        PWM_setDutyCycle(TIM16, note_freq, 50, psc_val_pwm); // 50% duty cycle
        delay_millis(TIM15, note_dur, psc_val_cnt);
    }

}