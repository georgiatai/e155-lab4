// main.c
// Fur Elise, E155 Lab 4
// Updated Fall 2024

// Pitch in Hz, duration in ms
const int notes[][2] = {
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{416,	125},
{494,	125},
{523,	250},
{  0,	125},
{330,	125},
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{523,	125},
{494,	125},
{440,	250},
{  0,	125},
{494,	125},
{523,	125},
{587,	125},
{659,	375},
{392,	125},
{699,	125},
{659,	125},
{587,	375},
{349,	125},
{659,	125},
{587,	125},
{523,	375},
{330,	125},
{587,	125},
{523,	125},
{494,	250},
{  0,	125},
{330,	125},
{659,	125},
{  0,	250},
{659,	125},
{1319,	125},
{  0,	250},
{623,	125},
{659,	125},
{  0,	250},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{416,	125},
{494,	125},
{523,	250},
{  0,	125},
{330,	125},
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{523,	125},
{494,	125},
{440,	500},
{  0,	0}};

const int cheat_code[][2] = {
    {370,  250}, // G♭4
    {311,  250}, // E♭4
    {311,  500}, // E♭4
    {370,  250}, // G♭4
    {466,  250}, // B♭4
    {415,  250}, // A♭4
    {370,  250}, // G♭4

    {349,  500}, // F4
    {277,  500}, // D♭4
    {349,  250}, // F4
    {415,  250}, // A♭4
    {370,  250}, // G♭4
    {349,  250}, // F4

    {311,  250}, // E♭4
    {370,  125}, // G♭4
    {311,  500}, // E♭4
    {311,  125}, // E♭4
    {349,  250}, // F4
    {415,  125}, // A♭4
    {349,  625}, // F4

    {466,  500}, // B♭4
    {466,  500}, // B♭4
    {466,  125}, // B♭4
    {466,  125}, // B♭4
    {466,  750}, // B♭4

    {370,  500}, // G♭4
    {311,  250}, // E♭4
    {311,  125}, // E♭4
    {370,  375}, // G♭4
    {466,  250}, // B♭4
    {415,  250}, // A♭4
    {370,  250}, // G♭4

    {415,  500}, // A♭4
    {554,  375}, // D♭5
    {466,  625}, // B♭4
    {415,  250}, // A♭4
    {466,  250}, // B♭4

    {493,  125}, // C♭5
    {466,  250}, // B♭4
    {466,  125}, // B♭4
    {415,  375}, // A♭4
    {415,  125}, // A♭4
    {370,  125}, // G♭4
    {493,  125}, // C♭5
    {466,  250}, // B♭4
    {466,  125}, // B♭4
    {415,  250}, // A♭4
    {622, 1625}, // D♭5

    {311,  250}, // E♭4
    {349,  250}, // F4

    {370,  500}, // G♭4
    {311,  500}, // E♭4
    {370,  250}, // G♭4
    {466,  250}, // B♭4
    {415,  250}, // A♭4
    {370,  250}, // G♭4

    {349,  500}, // F4
    {277,  500}, // D♭4
    {349,  250}, // F4
    {415,  250}, // A♭4
    {370,  250}, // G♭4
    {349,  250}, // F4

    {311,  250}, // E♭4
    {370,  125}, // G♭4
    {311,  500}, // E♭4
    {311,  125}, // E♭4
    {349,  250}, // F4
    {415,  125}, // A♭4
    {349,  625}, // F4

    {466,  500}, // B♭4
    {466,  500}, // B♭4
    {466,  125}, // B♭4
    {466,  125}, // B♭4
    {466,  750}, // B♭4

    {370,  500}, // G♭4
    {311,  250}, // E♭4
    {311,  125}, // E♭4
    {370,  375}, // G♭4
    {466,  250}, // B♭4
    {415,  250}, // A♭4
    {370,  250}, // G♭4

    {415,  500}, // A♭4
    {554,  375}, // D♭5
    {466,  625}, // B♭4
    {415,  250}, // A♭4
    {466,  250}, // B♭4

    {493,  125}, // C♭5
    {466,  250}, // B♭4
    {466,  250}, // B♭4
    {415,  125}, // A♭4
    {370,  500}, // G♭4
    {493,  375}, // D♭4
    {415, 2375}, // A♭4

    {466,  500}, // B♭4
    {493,  375}, // C♭5
    {415,  125}, // A♭4
    {  0, 1000}, // Rest

    {415,  500}, // A♭4
    {466,  375}, // B♭4
    {370,  125}, // G♭4
    {  0, 1000}, // Rest

    {  0,    0}  // End of song
};

int main(void) {
    configureFlash();
    configureClock();
	
    // Setting up clocks
    RCC->APB2ENR |= (1 << 0);  // GPIOA
    RCC->APB2ENR |= (1 << 16); // TIM15
    RCC->APB2ENR |= (1 << 17); // TIM16

    // Setting up GPIOA
    pinMode(5, 2); // PA5 as alternate function (TIM15_CH1)

    GPIO->MODER &= ~(0b11 << 2*5); // Clear mode bits for PA5
    GPIO->MODER |=  (0b10 << 2*5); // Set PA5 to alternate function mode

    GPIO->AFRL &= ~(0b1111 << 4*5); // Clear AFRL5
    GPIO->AFRL |=  (0b0010 << 4*5); // Set AFRL5 to AF2 (TIM15_CH1)
    
    // Initialize timers
    psc_val_cnt = 15; // freq_CLK / (psc_val + 1) = (80 MHz / (15 + 1)) = 5 MHz
    psc_val_pwm = 79; // freq_CLK / (psc_val + 1) = (80 MHz / (79 + 1)) = 1 MHz

    initTIM(TIM15, psc_val_cnt);
    initPWM(TIM16, psc_val_pwm);

    // for loop
	for (int i = 0; i < sizeof(notes) ; i++) {
        int note_freq = notes[i][0];
        int note_dur  = notes[i][1];

        PWM_setDutyCycle(TIM16, note_freq, 50); // 50% duty cycle
        delay_millis(TIM15, note_dur);

    }

}